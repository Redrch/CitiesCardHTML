# 城市卡牌游戏 Vue 版本 - 综合文档

**最后更新**: 2026-01-21

本文档整合了项目的所有重要信息，包括开发进度、Bug修复记录、技能实现状态等。

---

## 📋 目录

1. [项目概述](#项目概述)
2. [快速开始](#快速开始)
3. [开发进度](#开发进度)
4. [技能系统](#技能系统)
5. [Bug修复记录](#bug修复记录)
6. [测试指南](#测试指南)
7. [用户指南](#用户指南)

---

## 项目概述

城市卡牌游戏是一款基于中国城市的策略卡牌游戏，原版为单文件HTML实现（citycard_web.html），现已重构为Vue 3 + Vite架构。

### 技术栈
- **前端框架**: Vue 3 (Composition API)
- **状态管理**: Pinia
- **构建工具**: Vite
- **在线对战**: Firebase Realtime Database
- **测试框架**: Vitest

### 游戏模式
- **单机模式**: 与AI对战，支持2P/3P/2v2模式
- **在线对战**: 支持Firebase实时同步的在线多人游戏
  - **2P对战**: 两人对战模式
  - **3P混战**: 三人混战模式
  - **2v2团队**: 2v2团队对战模式

---

## 快速开始

### 安装依赖
```bash
npm install
```

### 本地开发
```bash
npm run dev
```

### 构建生产版本
```bash
npm run build
```

### 运行测试
```bash
npm run test
```

### 清除缓存（如遇到问题）
```bash
# 清除node_modules和缓存
rm -rf node_modules package-lock.json
npm cache clean --force
npm install

# 清除Vite缓存
rm -rf .vite
```

---

## 开发进度

### 整体完成度：~95%

#### ✅ 已完成功能

**核心游戏逻辑**
- [x] 城市数据系统（334座城市，含省份、人口、GDP等信息）
- [x] 战斗系统（2P/3P/2v2模式）
- [x] 金币系统（收入、支出、贷款机制）
- [x] 疲劳系统（连续出战HP减半）
- [x] 战斗前检测（同省撤退、省会归顺、晕头转向、波涛汹涌）

**技能系统**
- [x] 114个金币技能（战斗技能 + 非战斗技能）
- [x] 城市技能系统（基于城市特性的被动技能）
- [x] 技能效果系统（屏障、保护罩、钢铁城市等）

**UI组件**
- [x] 主菜单界面
- [x] 模式选择界面（单机/在线）
- [x] 城市选择界面（中心城市、预备城市）
- [x] 城市部署界面
- [x] 战斗动画系统
- [x] 游戏日志系统
- [x] 技能选择器
- [x] 对手城市查看面板

**在线对战**
- [x] Firebase配置和初始化
- [x] 房间创建和加入
- [x] 实时数据同步
- [x] 玩家准备和部署
- [x] 战斗计算和结果同步
- [x] 观战模式

#### 🚧 待完善功能

- [ ] 3P模式的完整测试
- [ ] 2v2模式的完整测试
- [ ] 部分城市技能的细节优化
- [ ] 音效和背景音乐
- [ ] 移动端适配优化

---

## 技能系统

### 金币技能（114个）

#### 战斗金币技能（36个）
包括：擒贼擒王、草木皆兵、越战越勇、吸引攻击、铜墙铁壁、背水一战、料事如神、同归于尽、设置屏障、潜能激发、御驾亲征、狂暴模式、按兵不动、既来则安、反戈一击、暗度陈仓、声东击西、以逸待劳、草船借箭、围魏救赵、欲擒故纵、晕头转向、隔岸观火、挑拨离间、趁火打劫、玉碎瓦全、合纵连横、寸步难行、抛砖引玉等

#### 非战斗金币技能（78个）
包括：
- **资源管理类**（7个）：转账给他人、金币贷款、金融危机、釜底抽薪、趁火打劫、计划单列、无中生有
- **治疗/HP增强类**（10个）：快速治疗、高级治疗、借尸还魂、实力增强、士气大振、苟延残喘、众志成城、焕然一新、厚积薄发、血量存储
- **保护/防御类**（12个）：城市保护、钢铁城市、定海神针、坚不可摧、步步高升、海市蜃楼、副中心制、生于紫室、深藏不露、技能保护等
- **攻击/伤害类**（18个）：无知无畏、一落千丈、连续打击、波涛汹涌、狂轰滥炸、横扫一空、万箭齐发、降维打击、定时爆破、永久摧毁等
- **控制/交换类**（15个）：先声夺人、时来运转、人质交换、改弦更张、拔旗易帜、避而不见、狐假虎威、李代桃僵、好高骛远等
- **情报/侦查类**（6个）：城市侦探、城市预言、明察秋毫、一举两得、不露踪迹、博学多才
- **省份相关类**（11个）：四面楚歌、搬运救兵、大义灭亲、强制搬运、代行省权、守望相助、行政中心、以礼来降、趁其不备等
- **特殊机制类**（14个）：无懈可击、事半功倍、过河拆桥、解除封锁、一触即发、突破瓶颈、当机立断、强制迁都、言听计从、电磁感应等

### 城市技能

基于城市特性的被动技能，包括：
- 省会城市技能
- 直辖市技能
- 特区技能
- 计划单列市技能
- 副省级城市技能
- 沿海城市技能
- 内陆城市技能
- 高GDP城市技能
- 高人口城市技能

详细实现请参考：`src/composables/citySkills/`

---

## Bug修复记录

### 最新修复（2026-01-20）

#### Bug 1: 技能冷却系统不生效
**问题**: 定海神针、先声夺人、永久摧毁、坚不可摧、城市试炼等技能使用后，冷却时间不递减，导致技能永远无法再次使用。

**根本原因**: `gameStore.js`的`updateRoundStates()`函数中缺少技能冷却时间的递减逻辑。虽然有其他所有回合状态的递减逻辑（金币贷款、禁用城市、保护罩、伪装、护盾、坚不可摧、定时炸弹、天灾人祸、金融危机、技能保护、治疗、偷取技能、不露踪迹、禁用技能、寸步难行、电磁感应等），但唯独遗漏了cooldowns的递减。

**修复方案**:
- 在`updateRoundStates()`函数中添加cooldowns递减逻辑
- 遍历所有玩家的冷却技能，每回合递减1
- 冷却完成时删除记录并添加日志提示
- 清理空的玩家冷却记录

**修复文件**:
- `src/stores/gameStore.js` (lines 1199-1214)

**受影响的技能**（6个）:
1. 定海神针 - 冷却1回合
2. 先声夺人 - 冷却3回合
3. 永久摧毁 - 冷却5回合
4. 坚不可摧 - 冷却5回合
5. 城市试炼 - 冷却5回合
6. 寸步难行 - 冷却5回合（战斗技能）

详细修复报告请参考：[BUGFIX_REPORT_SKILL_COOLDOWNS.md](../BUGFIX_REPORT_SKILL_COOLDOWNS.md)

#### Bug 2: 疲劳系统不生效
**问题**: 城市连续出战时没有触发疲劳减半（HP减半）

**根本原因**:
1. `streak`（疲劳计数器）数据未保存到Firebase
2. `streak`数据未从Firebase加载到gameStore
3. 同省撤退/归顺时，`preBattleChecks`更新了streak但被`updateFatigueStreaks`清零

**修复方案**:
- 在`handleEndTurn`中添加streak同步到Firebase
- 在`syncRoomDataToGameStore`中添加从Firebase加载streak
- 在`processBattle`中，调用`applyFatigueReduction`前同步streak
- 在`preBattleChecks.js`中，同时更新`gameStore.players.streaks`和`roomData.players.streaks`

**修复文件**:
- `src/components/PlayerMode/PlayerModeOnline.vue` (lines 665-673, 1481-1521, 2040-2057)
- `src/composables/game/preBattleChecks.js` (lines 545-565, 593-640)

#### Bug 2: 快速治疗失败
**问题**: 快速治疗技能报错 `initialCities maxHp: undefined`

**根本原因**: `gameStore.initialCities`未在游戏开始时初始化

**修复方案**:
- 在`handleDeploymentConfirmed`中初始化`initialCities`
- 在`executeKuaiSuZhiLiao`中添加备用maxHp获取逻辑（baseHp/maxHp/hp）

**修复文件**:
- `src/components/PlayerMode/PlayerModeOnline.vue` (lines 1408-1418)
- `src/composables/skills/nonBattleSkills.js` (lines 317-330)

### 历史Bug修复

详细的历史Bug修复记录请参考各个独立的修复报告文件。

---

## 测试指南

### 单元测试

运行所有测试：
```bash
npm run test
```

运行特定测试文件：
```bash
npm run test -- <test-file-name>
```

### 手动测试清单

#### 疲劳系统测试
1. 启动2P对战
2. 回合1：双方出战同省城市，触发同省撤退
3. 回合2：再次派出相同城市
4. **预期结果**: 城市HP减半，攻击力减半

#### 快速治疗测试
1. 启动游戏，选择一座城市
2. 让城市受到伤害（currentHp降低）
3. 使用快速治疗技能
4. **预期结果**: 城市HP恢复到初始最大HP

#### 战斗动画测试
1. 启动2P在线对战
2. 双方完成部署
3. 观察战斗动画播放
4. **预期结果**: 动画正常播放，显示攻击力、HP变化、特殊事件等

#### 同省规则测试
1. 启动2P对战
2. 双方选择同一省份的城市
3. 同时出战
4. **预期结果**: 触发同省撤退，双方城市撤回，金币+3

#### 省会归顺测试
1. 启动2P对战
2. 一方出战省会城市，另一方出战同省非省会城市
3. **预期结果**: 非省会城市归顺到有省会的一方

---

## 用户指南

### 游戏规则

#### 基本规则
1. 每位玩家抽取10座城市（2v2模式为7座）
2. 选择1座中心城市（不能被攻击，但可以主动出战）
3. 每回合获得3金币
4. 使用金币购买技能或直接出战城市
5. 战斗结算：攻击力 = 城市HP
6. 目标：消灭对手所有城市

#### 疲劳机制
- 城市连续第2次及以上出战时，战斗前HP减半
- 豁免技能：越战越勇、既来则安
- 疲劳在城市未出战时归零

#### 同省规则（仅2P模式）
- **同省撤退**: 双方都有同一省份的城市出战时，所有出战城市撤回，不发生战斗
- **省会归顺**: 一方有省会出战，另一方同省非省会城市归顺到有省会的一方

#### 金币系统
- 每回合基础收入：3金币
- 金币贷款：借10金币，每回合扣1金币，持续10回合
- 金融危机：强制对手贷款
- 转账：将金币转给其他玩家

### 游戏流程

#### 开始游戏
1. 启动游戏，进入主菜单
2. 点击"开始游戏"
3. 选择游戏模式：
   - **单机模式**: 与AI对战，适合练习
   - **在线对战**: 与真实玩家对战

#### 单机模式流程
1. 输入玩家昵称
2. 选择对战模式（2P/3P/2v2）
3. 抽取初始城市
4. 选择中心城市
5. 开始游戏，与AI对战

#### 在线对战流程
1. 创建或加入房间
2. 等待其他玩家加入
3. 所有玩家准备完毕
4. 选择中心城市
5. 每回合部署城市和使用技能
6. 战斗计算和结果同步

### 在线对战指南

#### 创建房间
1. 在模式选择界面点击"在线对战"
2. 输入房间号（4-6位数字）
3. 输入玩家名称
4. 选择游戏模式（2P/3P/2v2）
5. 等待其他玩家加入

#### 加入房间
1. 在模式选择界面点击"在线对战"
2. 输入房间号
3. 输入玩家名称
4. 点击"加入房间"

#### 游戏流程
1. 所有玩家准备完毕
2. 选择中心城市
3. 每回合：
   - 选择出战城市（最多3座）
   - 可选：使用金币技能
   - 可选：激活城市技能
   - 确认部署
4. 等待战斗计算
5. 查看战斗结果和日志
6. 进入下一回合

#### 观战模式
- 房间满员后加入的玩家自动成为观战者
- 观战者可以查看游戏日志，但不能参与游戏

---

## 项目结构

```
citycard-vue/
├── src/
│   ├── components/          # Vue组件
│   │   ├── Game/           # 游戏核心组件
│   │   ├── PlayerMode/     # 玩家模式组件
│   │   ├── Room/           # 房间相关组件
│   │   ├── Skills/         # 技能相关组件
│   │   └── Firebase/       # Firebase配置组件
│   ├── composables/        # 组合式函数
│   │   ├── game/          # 游戏逻辑
│   │   ├── skills/        # 技能实现
│   │   ├── citySkills/    # 城市技能
│   │   └── skillCore/     # 技能核心系统
│   ├── stores/            # Pinia状态管理
│   ├── data/              # 游戏数据
│   └── assets/            # 静态资源
├── docs/                  # 文档
└── tests/                 # 测试文件
```

---

## 贡献指南

### 代码规范
- 使用Vue 3 Composition API
- 遵循ESLint规则
- 添加必要的注释和文档
- 编写单元测试

### 提交规范
- feat: 新功能
- fix: Bug修复
- docs: 文档更新
- refactor: 代码重构
- test: 测试相关
- chore: 构建/工具相关

---

## 常见问题

### Q: 如何进入单机模式？
A: 主菜单点击"开始游戏"，在模式选择界面选择"单机模式"即可。

### Q: 单机模式和在线对战有什么区别？
A: 单机模式与AI对战，随时可以开始；在线对战与真实玩家对战，需要创建/加入房间。

### Q: 游戏卡在"战斗计算中"？
A: 检查控制台是否有错误，尝试刷新页面。如果问题持续，清除缓存后重新加载。

### Q: 技能使用后没有效果？
A: 确保满足技能使用条件（金币、目标城市等），检查游戏日志查看详细信息。

### Q: 在线对战连接失败？
A: 检查Firebase配置是否正确，确保网络连接正常。

### Q: 疲劳系统不生效？
A: 已在2026-01-20修复，确保使用最新版本。

---

## 更新日志

### 2026-01-21
- ✅ 添加游戏模式选择界面（单机/在线）
- ✅ 实现单机模式入口（与AI对战）
- ✅ 优化游戏流程（主菜单 → 模式选择 → 游戏）
- ✅ 更新综合文档

### 2026-01-20
- ✅ 优化主界面UI设计（添加单机模式入口、美化视觉效果）
- ✅ 修复高级治疗技能Bug（3个问题：选择器、在线模式兼容、失败提示）
- ✅ 修复技能冷却系统不生效的Bug（6个技能受影响）
- ✅ 添加技能失败提示弹窗功能
- ✅ 修复疲劳系统不生效的Bug
- ✅ 修复快速治疗技能失败的Bug
- ✅ 添加房间号显示功能
- ✅ 整合文档，创建综合文档

### 2026-01-19
- ✅ 完成战斗动画系统
- ✅ 修复特殊事件动画显示问题
- ✅ 优化战斗日志系统

### 2026-01-18
- ✅ 完成所有114个金币技能实现
- ✅ 完成城市技能系统
- ✅ 完成在线对战基础功能

---

## 联系方式

如有问题或建议，请通过以下方式联系：
- GitHub Issues
- 项目讨论区

---

**最后更新**: 2026-01-21
**版本**: v1.0.0
**完成度**: ~95%
