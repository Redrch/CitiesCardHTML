import"./index-C0lcZw7Q.js";function H(t,i,l){const f=t.players.find(n=>n.name===i);if(!f||!f.cities[l])return null;const e=f.cities[l];return t.changeFlagMark&&t.changeFlagMark[i]&&t.changeFlagMark[i][l]?t.changeFlagMark[i][l].newProvince:e.province}function g(t,i,l){const f=t.players.find(n=>n.name===i);if(!f||!f.cities[l])return null;const e=f.cities[l];if(t.disguisedCities&&t.disguisedCities[i]&&t.disguisedCities[i][l]){const n=t.disguisedCities[i][l];if(n.active&&n.fakeHp>0)return n.fakeName}return e.name}function R(t){return["哈尔滨市","长春市","沈阳市","呼和浩特市","石家庄市","太原市","济南市","郑州市","西安市","兰州市","银川市","西宁市","乌鲁木齐市","拉萨市","南京市","合肥市","杭州市","南昌市","福州市","武汉市","长沙市","广州市","南宁市","海口市","成都市","贵阳市","昆明市","台北市"].includes(t)}function b(t){return["内蒙古自治区","广西壮族自治区","西藏自治区","宁夏回族自治区","新疆维吾尔自治区"].includes(t)?"首府":"省会"}function j(t,i,l){if(!t.dizzy||Object.keys(t.dizzy).length===0)return!1;let f=!1;for(const e of Object.keys(t.dizzy)){const n=t.dizzy[e];if(!n||!n.target)continue;const C=t.players.find(c=>c.name===e),$=t.players.find(c=>c.name===n.target);if(!C||!$)continue;const h=i.playerStates[e],u=i.playerStates[n.target];if(!h||!u)continue;const s=(h.currentBattleCities||[]).map(c=>c.cityIdx),x=(u.currentBattleCities||[]).map(c=>c.cityIdx),o=C.centerIndex??0,r=$.centerIndex??0,a=s.filter(c=>!(c===o||t.hasIronShield(e,c)||t.anchored[e]&&t.anchored[e][c]||t.isInCautiousSet(e,c))),p=x.filter(c=>!(c===r||t.hasIronShield(n.target,c)||t.anchored[n.target]&&t.anchored[n.target][c]||t.isInCautiousSet(n.target,c)));if(a.length===0&&p.length===0){s.length>0||x.length>0?(t.addLog(">>> (晕头转向) 技能使用失败：所有出战城市都是中心城市、钢铁城市或被定海神针保护，返还10金币"),C.gold=(C.gold||0)+10):t.addLog(">>> (晕头转向) 技能使用失败：双方都未出战，金币不返还");continue}if(a.length>0&&p.length>0){const c=Math.min(a.length,p.length);for(let y=0;y<c;y++){const M=C.cities[a[y]];if(C.cities[a[y]]=$.cities[p[y]],$.cities[p[y]]=M,t.initialCities[e]&&t.initialCities[n.target]){const I=t.initialCities[e][a[y]];t.initialCities[e][a[y]]=t.initialCities[n.target][p[y]],t.initialCities[n.target][p[y]]=I}}h.currentBattleCities=[],u.currentBattleCities=[],t.addLog(`>>> (晕头转向) ${e}和${n.target}的出战城市互换后撤回`),f=!0}}return f}function T(t,i,l){if(l.length!==2)return!1;const f=l[0],e=l[1],n=i.playerStates[f.name],C=i.playerStates[e.name];if(!n||!C)return!1;const $=(n.currentBattleCities||[]).map(s=>s.cityIdx),h=(C.currentBattleCities||[]).map(s=>s.cityIdx),u=[{},{}];for(let s=0;s<2;s++){const x=l[s],o=s===0?$:h;for(const r of o){const a=H(t,x.name,r);a&&a!=="直辖市和特区"&&(u[s][a]||(u[s][a]=[]),u[s][a].push(r))}}for(let s=0;s<2;s++){const x=1-s,o=l[s],r=l[x];for(const a in u[s]){const p=u[s][a],c=u[x][a]||[];if(c.length===0||!p.some(d=>{if(t.reversedCapitals&&t.reversedCapitals[o.name]&&t.reversedCapitals[o.name][d])return!1;const k=g(t,o.name,d);return!!R(k)}))continue;const M=p.some(d=>{if(t.reversedCapitals&&t.reversedCapitals[o.name]&&t.reversedCapitals[o.name][d])return!1;const k=g(t,o.name,d);return R(k)}),I=c.some(d=>{if(t.reversedCapitals&&t.reversedCapitals[r.name]&&t.reversedCapitals[r.name][d])return!1;const k=g(t,r.name,d);return R(k)});if(M&&I){const d=i.playerStates[o.name],k=i.playerStates[r.name],L=p.map(B=>g(t,o.name,B)),v=c.map(B=>g(t,r.name,B));d.currentBattleCities=d.currentBattleCities.filter(B=>!p.includes(B.cityIdx)),k.currentBattleCities=k.currentBattleCities.filter(B=>!c.includes(B.cityIdx));const P=b(a);return t.addLog(`>>> (同省撤退) ${o.name}和${r.name}同时出战了${a}${P}，双方所有${a}城市撤退（${o.name}：${L.join("、")}；${r.name}：${v.join("、")}）`),!0}if(M&&!I){const d=[];for(const v of c){const P=r.cities[v],B=g(t,r.name,v);if(t.disguisedCities&&t.disguisedCities[r.name]&&t.disguisedCities[r.name][v]){const z=t.disguisedCities[r.name][v];if(z.active){P.currentHp=0,P.isAlive=!1,z.paid||(r.gold=Math.max(0,(r.gold||0)-9),z.paid=!0),z.active=!1,t.addLog(`  (省会归顺) ${r.name}的狐假虎威伪装${z.fakeName}被识破，实为${P.name}，自毁并扣9金币`);continue}}d.push(B),P.currentHp=0,P.isAlive=!1}if(d.length>0){const v=b(a);t.addLog(`>>> (${v}归顺) ${o.name}出战了${a}${v}，${r.name}的${a}城市${d.join("、")}归顺`)}const k=i.playerStates[o.name],L=i.playerStates[r.name];return k.currentBattleCities=[],L.currentBattleCities=[],!0}}}return!1}function N(t,i){if(!t.btxx||Object.keys(t.btxx).length===0)return;const l=["大连市","秦皇岛市","唐山市","天津市","东营市","烟台市","威海市","青岛市","日照市","连云港市","盐城市","南通市","上海市","宁波市","温州市","福州市","厦门市","泉州市","汕头市","深圳市","珠海市","广州市","湛江市","北海市","海口市","三亚市","台北市","高雄市","香港","澳门"];for(const f of Object.keys(t.btxx)){const e=t.btxx[f];if(!e||!e.target||e.appliedThisRound)continue;const n=t.players.find($=>$.name===e.target);if(!n)continue;const C=i.playerStates[e.target];if(!(!C||!C.currentBattleCities)){for(const $ of C.currentBattleCities){const h=$.cityIdx,u=n.cities[h];if(!u||!u.isAlive)continue;const s=u.name;if(!l.includes(s))continue;if(h===(n.centerIndex??0)&&t.checkMirageBlock&&t.checkMirageBlock(e.target,`${f}的波涛汹涌`)){t.addLog(`  (波涛汹涌) ${e.target}的海市蜃楼拦截了伤害`);continue}if(t.hasIronShield(e.target,h)){t.addLog(`  (波涛汹涌) ${e.target}的${s}为钢铁城市，免疫波涛汹涌`);continue}if(t.hasProtection(e.target,h)){t.consumeProtection(e.target,h),t.addLog(`  (波涛汹涌) ${e.target}的${s}有保护罩，保护罩破裂，未减半`);continue}const o=u.currentHp;u.currentHp=Math.floor(u.currentHp/2),t.addLog(`  (波涛汹涌) ${e.target}的${s}本回合出战且为沿海城市，战斗前HP减半：${Math.floor(o)} -> ${Math.floor(u.currentHp)}`)}e.appliedThisRound=!0}}}function E(t,i,l,f){return console.log("[PreBattleChecks] 开始执行战斗前检测"),j(t,i)?(console.log("[PreBattleChecks] 晕头转向触发撤退"),!0):(f==="2P"||f==="2p")&&T(t,i,l)?(console.log("[PreBattleChecks] 同省撤退/省会归顺触发"),!0):(N(t,i),console.log("[PreBattleChecks] 战斗前检测完成"),!1)}export{N as checkBtxxEffect,j as checkDizzyEffect,T as checkProvinceRules,E as executePreBattleChecks};
